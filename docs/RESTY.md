# Resty CLI

Official Repo: https://github.com/openresty/resty-cli

## Install

### Alpine

```bash
apk add perl # resty-cli requires perl to be available
curl -so /usr/local/bin/resty https://raw.githubusercontent.com/openresty/resty-cli/v0.29/bin/resty
chmod +x /usr/local/bin/resty
```

### Debian-based

```bash
apt update && apt install -y perl # resty-cli requires perl to be available
curl -so /usr/local/bin/resty https://raw.githubusercontent.com/openresty/resty-cli/v0.29/bin/resty
chmod +x /usr/local/bin/resty
```

### RHEL-based

```bash
yum install -y perl # resty-cli requires perl to be available
curl -so /usr/local/bin/resty https://raw.githubusercontent.com/openresty/resty-cli/v0.29/bin/resty
chmod +x /usr/local/bin/resty
```

## Run

```bash
$ resty --help
resty [options] [lua-file [args]]

Options:
    -c NUM              Set maximal connection count (default: 64).
    -e PROG             Run the inlined Lua code in "prog".

    --errlog-level LEVEL
                        Set nginx error_log level.
                        Can be debug, info, notice, warn, error, crit, alert,
                        or emerg.

    --gdb               Use GDB to run the underlying nginx C process.

    --gdb-opts OPTS     Pass extra command-line options to GDB.

    --help              Print this help.

    --http-conf CONF    Specifies nginx.conf snippet inserted into the http {}
                        configuration block (multiple instances are supported).

    --http-include PATH Include the specified file in the nginx http
                        configuration block (multiple instances are supported).

    -I DIR              Add dir to the search paths for Lua libraries.

    -j dump             Use LuaJIT's jit.dump module to output detailed info of
                        the traces generated by the JIT compiler.

    -j off              Turn off the LuaJIT JIT compiler.

    -j v                Use LuaJIT's jit.v module to output brief info of the
                        traces generated by the JIT compiler.

    -l LIB              Require library "lib".

    --main-conf CONF    Specifies nginx.conf snippet inserted into the nginx
                        main {} configuration block (multiple instances are
                        supported).

    --main-include PATH Include the specified file in the nginx main
                        configuration block (multiple instances are supported).

    --nginx             Specify the nginx path (this option might be removed
                        in the future).

    --no-stream         Disable the stream {} configuration in auto-generated
                        nginx.conf.

    --ns IP             Specify a custom name server (multiple instances are
                        supported).

    --resolve-ipv6      Make the nginx resolver lookup both IPv4 and IPv6
                        addresses.

    --rr                Use Mozilla rr to record the execution of the
                        underlying nginx C process.

    --shdict 'NAME SIZE'
                        Create the specified lua shared dicts in the http
                        configuration block (multiple instances are supported).

    --stap
                        Use sysetmtap to run the underlying nginx C process.

    --stap-opts OPTS
                        Pass extra systemtap command line options.

    --user-runner CMD   Use CMD as user runner for the underlying nginx process.

    -V                  Print version numbers and nginx configurations.

    --valgrind          Use valgrind to run nginx.

    --valgrind-opts OPTS
                        Pass extra options to valgrind.

For bug reporting instructions, please see:

    <https://openresty.org/en/community.html>

Copyright (C) Yichun Zhang (agentzh). All rights reserved.
```

## Extras

### Testing with `busted`

#### Setup for Resty + Busted

Reference: https://github.com/lunarmodules/busted/issues/414#issuecomment-792614808

`spec/resty-runner.lua` (must be executable):

```lua
#!/usr/bin/env resty

-- script to run Busted tests using Openresty while setting some extra flags.
--
-- This script should be specified as:
--   busted --lua=<this-file>
--
-- Alternatively specify it in the `.busted` config file


-- These flags are passed to `resty` by default, to allow for more connections
-- and disable the Global variable write-guard. Override it by setting the
-- environment variable `BUSTED_RESTY_FLAGS`.
local RESTY_FLAGS=os.getenv("BUSTED_RESTY_FLAGS") or "-c 4096 -e 'setmetatable(_G, nil)'"

-- rebuild the invoked commandline, while inserting extra resty-flags
local cmd = {
  "exec",
  arg[-1],
  RESTY_FLAGS,
}
for i, param in ipairs(arg) do
  table.insert(cmd, "'" .. param .. "'")
end

local _, _, rc = os.execute(table.concat(cmd, " "))
os.exit(rc)
```

`.busted`:

```lua
return {
  default = {
    lua = "spec/resty-runner.lua",
    verbose = true,
    coverage = false,
    output = "gtest",
  },
}
```

#### Run

**NOTE:** Tested on `fabiocicerchia/nginx-lua:1.25.1-alpine3.18.2`.

Official Repo: https://github.com/thibaultcha/lua-resty-busted

```bash
apk add git g++ make libc-dev # for alpine, otherwise use `apt` or `yum`
# Ref: https://github.com/thibaultcha/lua-resty-busted/issues/1
luarocks install https://raw.githubusercontent.com/thibaultcha/lua-resty-busted/master/lua-resty-busted-0.0.1-0.rockspec
```

```bash
curl -so spec/resty_busted_spec.lua https://raw.githubusercontent.com/thibaultcha/lua-resty-busted/master/spec/resty_busted_spec.lua
busted spec/
[==========] Running tests from scanned files.
[----------] Global test environment setup.
[----------] Running tests from spec/resty_busted_spec.lua
[ RUN      ] spec/resty_busted_spec.lua @ 2: lua-resty-busted should run in ngx_lua context
[       OK ] spec/resty_busted_spec.lua @ 2: lua-resty-busted should run in ngx_lua context (0.08 ms)
[ RUN      ] spec/resty_busted_spec.lua @ 7: lua-resty-busted calling ngx.exit should not exit
[       OK ] spec/resty_busted_spec.lua @ 7: lua-resty-busted calling ngx.exit should not exit (0.03 ms)
[----------] 2 tests from spec/resty_busted_spec.lua (0.42 ms total)

[----------] Global test environment teardown.
[==========] 2 tests from 1 test file ran. (0.62 ms total)
[  PASSED  ] 2 tests.
```
